<!DOCTYPE html>
<html>
  <head>
    <title>Decrediton Translator</title>
    <meta charset="utf-8" />

    <style>
      #error {
        color: red;
        padding: 2em;
      }

      #translation_ui {
        display: none;
        grid-template-columns: 2fr 4fr;
      }

      #string_list {
        border: 1px solid #ccc;
        margin: 10px;
        padding-right: 0.5em;
        padding-top: 1em;
        overflow: hidden scroll;
        height: 34em;
      }

      #string_list li {
        cursor: pointer;
        user-select: none;
        margin-bottom: 1em;
      }

      #string_list li:hover {
        cursor: pointer;
        color: blue;
      }

      #string_list li span {
        display: block;
        color: #888;
        font-size: 60%;
      }

      #string_list li.selected {
        color: #ff8051;
      }

      #key_str {
        color: #888;
        font-size: 60%;
        padding-top: 0.6rem;
      }

      #original_str,
      #prev_original_str {
        margin: 10px 0px;
        border: 1px solid #ccc;
        padding: 1em 1em 2em 1em;
      }

      #prev_original_str::after {
        display: block;
        position: absolute;
        font-size: 60%;
        color: #888;
        content: "Previous Original String";
        margin-top: 10px;
      }

      #original_str.inactive,
      #prev_original_str.inactive {
        background-color: lightgrey;
        color: grey;
      }

      #original_str::after {
        display: block;
        position: absolute;
        font-size: 60%;
        color: #888;
        content: "Original String";
        margin-top: 10px;
      }

      #buttons {
        margin: 10px 0px;
      }

      #translated_str {
        min-width: calc(100% - 2em);
        min-height: 10rem;
        font-size: 150%;
        padding: 1em 1em 2em 1em;
      }

      #translated_str:focus {
        outline: none;
      }

      #translated {
        position: relative;
      }

      #translated::after {
        display: block;
        position: absolute;
        font-size: 60%;
        color: #888;
        content: "Translated String";
        bottom: 4pt;
        left: 2em;
        right: 1rem;
        background-color: white;
        padding: 1rem 0;
      }

      #translated.disabled::after {
        background-color: transparent;
      }
    </style>

    <script>
      // Global state of the app.
      let state = {
        original: {},
        translated: {},
        selectedKey: "",
        previousKeys: [],
        seenKeys: [],
        prevOriginal: {},
        changedEntries: [],
        deletedEntries: []
      };

      function updateState(delta) {
        state = { ...state, ...delta };
      }

      function elID(id) {
        return document.getElementById(id);
      }

      function newEl(parent, tagname) {
        const el = document.createElement(tagname);
        parent.appendChild(el);
        return el;
      }

      function prepareTranslatedFile() {
        const translated = state.translated;
        let data = Object.keys(translated).sort().map(k => `  "${k}": ${JSON.stringify(translated[k])}`).join(",\n");
        let json = `{\n${data}\n}\n`;
        const file = new Blob([json], { type: "application/octet-stream" });
        const url = URL.createObjectURL(file);

        const downBtn = elID("down_translation_btn");
        downBtn.href = url;
        downBtn.download = "custom-translation.json";
      }

      function isEntryDeleted(key) {
        return (
          state.original[state.selectedKey] === undefined &&
          state.translated[state.selectedKey] !== undefined
        );
      }

      function saveTranslation() {
        if (state.selectedKey) {
          const isDeleted = isEntryDeleted(state.selectedKey);
          // Save last translation.
          if (!isDeleted) {
            state.translated[state.selectedKey] = elID("translated_str").value;
          }
          prepareTranslatedFile();
        }
      }

      function getFilterVal() {
        return document.querySelector('input[name="filter"]:checked').value;
      }

      function setFilterVal(value) {
        document.querySelector(`input[value="${value}"]`).checked = true;
      }

      function changeToKey(newkey) {
        saveTranslation();
        let v = state.translated[newkey] ? state.translated[newkey] : "";
        elID("translated_str").value = v;
        const filterVal = getFilterVal();
        let delta = {
          selectedKey: newkey,
          selectedFilterVal: filterVal
        };
        if (state.selectedKey && state.selectedKey != newkey) {
          const previousKeys = [...state.previousKeys];
          previousKeys?.push({
            selectedKey: state.selectedKey,
            filterVal: state.selectedFilterVal
          });
          delta = { ...delta, previousKeys };
        }
        updateState(delta);
        refreshUI();
      }

      function jumpToPreviousKey() {
        if (state.previousKeys.length > 0) {
          const previousKeys = [...state.previousKeys];
          const previousKey = previousKeys.pop();
          if (previousKey) {
            updateState({
              previousKeys: previousKeys,
              selectedKey: "" // prevent from save to previousKeys
            });
            setFilterVal(previousKey.filterVal);
            changeToKey(previousKey.selectedKey);
          }
        }
      }

      function refreshUI() {
        const filterVal = getFilterVal();
        const stringsEl = elID("string_list");
        stringsEl.innerHTML = "";

        if (filterVal === "deleted") {
          Object.keys(state.deletedEntries).map((k) => {
            const li = newEl(stringsEl, "li");
            li.innerText = state.deletedEntries[k];
            newEl(li, "span").innerText = "";

            if (state.deletedEntries[k] === state.selectedKey) {
              li.classList.add("selected");
              selectedEntry = k;
            }

            li.onclick = () => changeToKey(state.deletedEntries[k]);
          });
        } else {
          Object.keys(state.original).map((k) => {
            if (filterVal === "untranslated" && state.translated[k]) {
              return;
            }
            if (
              filterVal === "changed" &&
              state.changedEntries.indexOf(k) == -1
            ) {
              return;
            }
            if (
              filterVal === "deleted" &&
              state.deletedEntries.indexOf(k) == -1
            ) {
              return;
            }
            const li = newEl(stringsEl, "li");
            li.innerText = state.original[k];
            newEl(li, "span").innerText = k;

            if (k === state.selectedKey) {
              li.classList.add("selected");
            }

            li.onclick = () => changeToKey(k);
          });
        }

        const isDeleted = isEntryDeleted(state.selectedKey);

        if (isDeleted) {
          elID("original_str").classList.add("inactive");
          elID("translated").classList.add("disabled");
        } else {
          elID("original_str").classList.remove("inactive");
          elID("translated").classList.remove("disabled");
        }

        const origStr = state.original[state.selectedKey]
          ? state.original[state.selectedKey]
          : "";
        elID("original_str").innerText = origStr;

        const prevStr = state.prevOriginal[state.selectedKey]
          ? state.prevOriginal[state.selectedKey]
          : "";
        elID("prev_original_str").innerText = prevStr;
        if (prevStr == "" || origStr == prevStr) {
          elID("prev_original_str").classList.add("inactive");
        } else {
          elID("prev_original_str").classList.remove("inactive");
        }
        elID("key_str").innerText = state.selectedKey;

        elID("prev_bt").innerText = isDeleted ? "previous" : "save & previous";
        elID("prev_bt").disabled = state.previousKeys.length <= 0;
        elID("copy_bt").disabled = isDeleted || origStr === "";
        elID("next_bt").disabled = isDeleted;
        elID("translated_str").disabled = isDeleted;
      }

      function nextKey() {
        let gotPrev = false;
        let keys = Object.keys(state.original);
        const filterVal = getFilterVal();
        for (let i = 0; i < keys.length; i++) {
          const k = keys[i];
          // When on Untranslated view, skip to next key considered
          // "untranslated", i.e. undefined (new key) or "" (existing key with
          // empty translation).
          if (filterVal === "untranslated" && state.translated[k]) {
            continue;
          }
          // When on Changed view, skip to next key considered "changed".
          if (
            filterVal === "changed" &&
            state.changedEntries.indexOf(k) == -1
          ) {
            continue;
          }

          // When on Changed view, skip to next key considered "changed".
          if (filterVal === "changed" && state.changedEntries.indexOf(k) == -1) {
            continue;
          }

          if (gotPrev) {
            changeToKey(k);
            return;
          } else if (k === state.selectedKey) {
            gotPrev = true;
          }
        }

        if (gotPrev) {
          // gotPrev but not the next one, so reached the end of the list.
          saveTranslation();
          state.selectedKey = "";
          jumpToFirstKey();
        }
      }

      function jumpToFirstKey() {
        let keys = Object.keys(state.original);
        const filterVal = getFilterVal();
        for (let i = 0; i < keys.length; i++) {
          const k = keys[i];
          if (filterVal === "untranslated" && state.translated[k]) {
            continue;
          }
          // When on Changed view, skip to next key considered "changed".
          if (
            filterVal === "changed" &&
            state.changedEntries.indexOf(k) == -1
          ) {
            continue;
          }

          changeToKey(k);
          return;
        }
      }

      function textAreaKeyDown(event) {
        if (event.keyCode === 9) {
          event.preventDefault();
          let v = this.value;
          let s = this.selectionStart;
          let e = this.selectionEnd;
          this.value = v.substring(0, s) + "    " + v.substring(e);
          this.selectionStart = this.selectionEnd = s + 1;
          return false;
        }
        if (event.keyCode === 13 && event.ctrlKey) {
          event.preventDefault();
          nextKey();
          return false;
        }
        if (event.key === "g" && event.ctrlKey) {
          event.preventDefault();
          copyOriginal();
          return false;
        }
      }

      function copyOriginal() {
        let originalStr = state.original[state.selectedKey];
        elID("translated_str").value = originalStr;
      }

      async function dotry(f, ...args) {
        try {
          await f(...args);
        } catch (error) {
          const el = elID("error");
          el.innerText = "Caught exception: " + String(error);
          el.hidden = false;
          throw error;
        }
      }

      function readFile(id) {
        return new Promise((ok) => {
          const el = elID(id);
          const reader = new FileReader();
          reader.onload = function (e) {
            const data = JSON.parse(e.target.result);
            ok(data);
          };
          reader.readAsText(el.files[0]);
        });
      }

      async function startTranslation() {
        const prevOrig = await readFile("prevoriginal_file");
        const orig = await readFile("original_file");
        const translated = await readFile("lang_file");

        // Figure out all changed entries between prevOrig and orig.
        const changedEntries = [];
        const deletedEntries = [];
        Object.keys(prevOrig).forEach((k) => {
          if (orig[k] === undefined && translated[k] !== undefined)
            deletedEntries.push(k);
          else if (orig[k] !== prevOrig[k]) changedEntries.push(k);
        });

        updateState({
          original: orig,
          translated: translated,
          prevOriginal: prevOrig,
          changedEntries,
          deletedEntries
        });
        prepareTranslatedFile();

        refreshUI();

        elID("load_files").hidden = true;
        elID("translation_ui").style.display = "grid";
      }
    </script>
  </head>

  <body>
    <div id="error" hidden="true"></div>

    <div id="load_files">
      <div>
        Load the "previous_original.json" file:
        <input id="prevoriginal_file" type="file" />
      </div>
      <div>
        Load the "original.json" file: <input id="original_file" type="file" />
      </div>
      <div>
        Load the "[language].json" file: <input id="lang_file" type="file" />
      </div>
      <div><button onclick="dotry(startTranslation)">Start</button></div>
    </div>

    <div id="translation_ui">
      <div>
        <div>
          <input
            type="radio"
            name="filter"
            value="all"
            checked="checked"
            onclick="dotry(refreshUI)"
          />All
          <input
            type="radio"
            name="filter"
            value="untranslated"
            onclick="dotry(refreshUI)"
          />Untranslated
          <input
            type="radio"
            name="filter"
            value="changed"
            checked="checked"
            onclick="dotry(refreshUI)"
          />Changed
          <input
            type="radio"
            name="filter"
            value="deleted"
            onclick="dotry(refreshUI)"
          />Deleted
        </div>

        <ul id="string_list"></ul>
      </div>

      <div>
        <div id="key_str"></div>
        <div id="prev_original_str"></div>
        <div id="original_str"></div>

        <div id="buttons">
          <button
            onclick="jumpToPreviousKey()"
            title="Previous String"
            id="prev_bt"
          >
            save & previous
          </button>
          <button
            onclick="copyOriginal()"
            title="Copy original (ctrl+g)"
            id="copy_bt"
          >
            copy original
          </button>
          <button
            onclick="nextKey()"
            title="Next String (ctrl+enter)"
            id="next_bt"
          >
            save & next
          </button>
          <a id="down_translation_btn" onclick="saveTranslation()" href="#"
            >Save Translation</a
          >
        </div>

        <div style="font-size: 60%; color: #888">
          ctrl+&lt;enter&gt;: save string & goto next<br />
          ctrl+g: copy original string
        </div>

        <div id="translated">
          <textarea
            rows="10"
            id="translated_str"
            onkeydown="textAreaKeyDown.apply(this, [event])"
          ></textarea>
        </div>
      </div>
    </div>
  </body>
</html>
